{% extends "base.html" %}
{% load static %}

{% block nav_links %}
<a
href="https://github.com/KristianMSchmidt/semantic-art-search/blob/master/README.md"
target="_blank" rel="noopener noreferrer"
class="text-blue-100 hover:text-blue-50"
title="View on GitHub"
>
    <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.207 11.387.6.11.793-.26.793-.577v-2.234c-3.338.724-4.033-1.61-4.033-1.61-.547-1.387-1.335-1.756-1.335-1.756-1.092-.746.083-.731.083-.731 1.206.084 1.84 1.238 1.84 1.238 1.073 1.837 2.812 1.306 3.497.998.11-.777.42-1.305.763-1.605-2.665-.305-5.466-1.332-5.466-5.931 0-1.31.467-2.381 1.235-3.221-.124-.303-.535-1.527.117-3.176 0 0 1.008-.322 3.3 1.23.957-.266 1.984-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.29-1.552 3.296-1.23 3.296-1.23.653 1.649.242 2.873.118 3.176.77.84 1.233 1.911 1.233 3.221 0 4.61-2.804 5.624-5.475 5.921.43.372.814 1.102.814 2.222v3.293c0 .32.192.694.8.576C20.565 21.796 24 17.297 24 12c0-6.63-5.37-12-12-12z"/>
    </svg>
</a>
{% endblock %}


{% block content %}
<div class="container mx-auto p-4">

    <!-- Text above search form -->
    <p class="text-sm text-gray-700 mb-2 mt-4">
        Discover art through meaning-driven search!
    </p>

     <!-- Search Form using HTMX -->
    <form
        id="search-form"
        hx-get="{% url 'get-artworks' %}"
        hx-target="#search-results"
        hx-swap="innerHTML"
        hx-include="#search-form"
        hx-on:submit="return validateSearchInput()"
        class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4 sm:mb-5">

        <!-- Search Input -->
        <input
            id="search-input"
            type="text"
            name="query"
            placeholder="Search by theme, style, emotion, or more..."
            value="{{ query|default:'' }}"
            class="w-full sm:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            required
        />

        <!-- Museum Dropdown -->
        <div
            id="museum-dropdown"
            class="w-full sm:w-auto"
            hx-get="{% url 'update-work-types' %}"
            hx-trigger="change delay:150ms"
            hx-include="#museum-dropdown, #work-type-container"
            hx-target="#work-type-container"
            hx-swap="innerHTML"
        >
            {% with filter_ctx=museum_filter_context %}
                {% include "partials/dropdown.html" %}
            {% endwith %}
        </div>

        <!-- Work Type Dropdown -->
        <div
            id="work-type-container"
            class="w-full sm:w-auto"
            hx-get="{% url 'update-museums' %}"
            hx-trigger="change delay:150ms"
            hx-include="#work-type-container, #museum-dropdown"
            hx-target="#museum-dropdown"
            hx-swap="innerHTML"
        >
            {% with filter_ctx=work_type_filter_context %}
                {% include "partials/dropdown.html" %}
            {% endwith %}
        </div>

        <!-- HTMX Submit Button -->
        <button
            type="submit"
            class="w-full sm:w-auto bg-blue-500 text-white px-8 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
            Search
        </button>

    </form>

    <!-- Example Queries Section -->
    <div class="mb-5">
        <p class="text-sm text-gray-600 mb-2">Try these examples</p>

        <!-- Desktop View: show all examples -->
        <div class="hidden sm:flex flex-wrap gap-2">
            {% for example in example_queries %}
            <button
                type="button"
                class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                onclick="insertQuery('{{ example }}')"
                hx-get="{% url 'get-artworks' %}"
                hx-target="#search-results"
                hx-swap="innerHTML"
                hx-include="#search-form"
            >
                {{ example }}
            </button>
            {% endfor %}
        </div>

        <!-- Mobile View: show a few examples and a "More"/"Less" toggle -->
        <div class="sm:hidden" x-data="{ showAll: false }"
             @htmx:after-swap.window="if ($event.detail.target.id === 'search-results') showAll = false">
            <!-- collapsed state -->
            <div class="flex flex-wrap gap-2" x-show="!showAll">
                {% for example in example_queries|slice:":5" %}
                <button
                    type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onclick="insertQuery('{{ example }}')"
                    hx-get="{% url 'get-artworks' %}"
                    hx-target="#search-results"
                    hx-swap="innerHTML"
                    hx-include="#search-form"
                >
                    {{ example }}
                </button>
                {% endfor %}
                <button
                    type="button"
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    x-on:click="showAll = true; setTimeout(() => $event.target.blur(), 100)"
                    x-on:touchend="setTimeout(() => $event.target.blur(), 100)"
                >
                    More
                </button>
            </div>

            <!-- expanded state -->
            <div class="flex flex-wrap gap-2" x-show="showAll">
                {% for example in example_queries %}
                <button
                    type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onclick="insertQuery('{{ example }}')"
                    hx-get="{% url 'get-artworks' %}"
                    hx-target="#search-results"
                    hx-swap="innerHTML"
                    hx-include="#search-form"
                >
                    {{ example }}
                </button>
                {% endfor %}
                <button
                    type="button"
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    x-on:click="showAll = false; setTimeout(() => $event.target.blur(), 100)"
                    x-on:touchend="setTimeout(() => $event.target.blur(), 100)"
                >
                    Less
                </button>
            </div>
        </div>
    </div>

    <!-- Error Message Placeholder -->
    <div id="error-message"></div>

    <!-- Get artworks -->
    <div id="search-results">
        <div
            hx-get="{% url 'get-artworks' %}"
            hx-trigger="revealed"
            hx-swap="outerHTML"
            class="py-4 text-center text-gray-500">
        </div>
    </div>
</div>

<!-- Full-screen Image Viewer -->
<div x-data="{
  open: false,
  url: '',
  showInfo: false,
  title: '',
  artist: '',
  productionDate: '',
  workTypes: [],
  museum: '',
  sourceUrl: '',
  findSimilarQuery: '',
  showFindSimilar: true,
  openWith(data) {
    this.url = data.url;
    this.title = data.title || '';
    this.artist = data.artist || '';
    this.productionDate = data.productionDate || '';
    this.workTypes = data.workTypes || [];
    this.museum = data.museum || '';
    this.sourceUrl = data.sourceUrl || '';
    this.findSimilarQuery = data.findSimilarQuery || '';
    this.showFindSimilar = data.showFindSimilar || false;
    this.open = true;
    this.showInfo = false;
    document.body.style.overflow = 'hidden';
  },
  close() {
    this.open = false;
    this.showInfo = false;
    document.body.style.overflow = '';
  }
}"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 bg-black/95"
     @keydown.escape.window="if (open) close()"
     @open-viewer.window="openWith($event.detail)">

  <!-- Top bar -->
  <div class="absolute top-0 left-0 right-0 p-3 flex items-center justify-between text-white z-10"
       @click.stop>
    <div class="text-sm opacity-80">Click image to toggle info<span class="hidden lg:inline"> â€¢ Esc to close</span></div>
    <button class="px-3 py-1 rounded bg-white/10 hover:bg-white/20 transition"
            :class="{ 'lg:mr-96': showInfo }"
            @click="close()">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
  </div>

  <!-- Image: uses whole viewport, never inside a scrollable parent -->
  <div class="w-screen h-screen flex items-center justify-center">
    <img :src="url"
         alt="Artwork"
         class="block max-w-[100vw] max-h-[100vh] select-none cursor-pointer"
         @click.stop="showInfo = !showInfo"
         draggable="false">
  </div>

  <!-- Info drawer -->
  <div x-show="showInfo"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0 translate-y-4 lg:translate-y-0 lg:translate-x-4"
       x-transition:enter-end="opacity-100 translate-y-0 lg:translate-x-0"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100 translate-y-0 lg:translate-x-0"
       x-transition:leave-end="opacity-0 translate-y-4 lg:translate-x-4"
       class="absolute bottom-0 left-0 right-0 lg:left-auto lg:top-0 lg:bottom-0 lg:w-96 bg-white text-gray-900 border-t lg:border-t-0 lg:border-l border-gray-200 max-h-[45vh] lg:max-h-none overflow-y-auto p-6 pb-[calc(1.5rem+env(safe-area-inset-bottom))]"
       @click.stop>

    <!-- Metadata block -->
    <div class="space-y-1">
      <!-- Title -->
      <h3 class="text font-semibold text-gray-800 leading-snug" x-text="title"></h3>

      <!-- Artist -->
      <p class="text-base text-gray-500" x-text="artist"></p>

      <!-- Production date and Work Types -->
      <div class="flex flex-wrap gap-2 mt-1">
        <span x-show="productionDate"
              x-text="productionDate"
              class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-md font-medium">
        </span>
        <template x-for="workType in workTypes" :key="workType">
          <span x-text="workType"
                class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-md font-medium">
          </span>
        </template>
      </div>
    </div>

    <!-- Museum link -->
    <p x-show="museum && sourceUrl" class="mt-4">
      <a :href="sourceUrl"
         target="_blank"
         rel="noopener noreferrer"
         class="text-sm text-gray-600 inline-flex items-center gap-1 underline hover:text-blue-500"
         :title="'View this artwork on the ' + museum + ' website'">
        <span x-text="museum"></span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6m5-5h5m0 0v5m0-5L10 14" />
        </svg>
      </a>
    </p>

    <!-- Find similar button -->
    <div x-show="showFindSimilar" class="mt-3">
      <button
        type="button"
        class="text-sm text-gray-600 hover:text-blue-500 underline"
        @click="insertQuery(findSimilarQuery); close()"
        hx-get="{% url 'get-artworks' %}"
        hx-target="#search-results"
        hx-swap="innerHTML"
        hx-include="#search-form">
        Find similar
      </button>
    </div>
  </div>
</div>


<!-- JavaScript Functions -->
<script>
    function validateSearchInput() {
        const input = document.getElementById("search-input");
        if (!input.value.trim()) {
            input.focus();
            input.reportValidity();  // shows browser's native "Please fill out this field" popup
            return false;
        }
        return true;
    }

    function insertQuery(query) {
        document.getElementById('search-input').value = query;
    }

    function dropdownComponent({ selected, all, labelName }) {
        return {
            open: false,
            selectedItems: [...selected],
            allItems: [...all],

            toggleSelectAll() {
                if (this.selectedItems.length === this.allItems.length) {
                    this.selectedItems = [];
                } else {
                    this.selectedItems = [...this.allItems];
                }
            },

            get buttonLabel() {
                if (this.selectedItems.length === 0 || this.selectedItems.length === this.allItems.length) {
                    return `All ${labelName}s`;
                } else if (this.selectedItems.length === 1) {
                    return `1 ${labelName}`;
                } else {
                    return `${this.selectedItems.length} ${labelName}s`;
                }
            }
        };
    }

  function openModal(data) {
    window.dispatchEvent(new CustomEvent('open-viewer', { detail: data }));
  }
</script>

<script>
    document.body.addEventListener('htmx:afterSwap', (evt) => {
      if (evt.detail.target.id === 'search-results') {
        window.scrollTo({ top: 0, behavior: 'auto' });
      }
    });
</script>
{% endblock content %}
