{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block nav_links %}
<!-- Language Selector -->
<div x-data="{ open: false }" class="relative" @click.away="open = false">
    <button
        @click="open = !open"
        class="text-blue-100 hover:text-blue-50 px-3 py-1 rounded flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd" />
        </svg>
        <span class="text-sm">{{ current_language_name }}</span>
        <svg class="w-4 h-4 transition-transform" :class="open ? 'rotate-180' : ''" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
    </button>
    <div x-show="open"
         x-cloak
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg py-1 z-50">
        {% for code, name in languages %}
        <form method="post" action="{% url 'set-language' %}">
            {% csrf_token %}
            <input type="hidden" name="language" value="{{ code }}">
            <button type="submit"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 {% if code == current_language %}bg-blue-50 font-medium{% endif %}">
                {{ name }}
            </button>
        </form>
        {% endfor %}
    </div>
</div>

<a
href="https://github.com/KristianMSchmidt/semantic-art-search/blob/master/README.md"
target="_blank" rel="noopener noreferrer"
class="text-blue-100 hover:text-blue-50"
title="View on GitHub"
>
    <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.207 11.387.6.11.793-.26.793-.577v-2.234c-3.338.724-4.033-1.61-4.033-1.61-.547-1.387-1.335-1.756-1.335-1.756-1.092-.746.083-.731.083-.731 1.206.084 1.84 1.238 1.84 1.238 1.073 1.837 2.812 1.306 3.497.998.11-.777.42-1.305.763-1.605-2.665-.305-5.466-1.332-5.466-5.931 0-1.31.467-2.381 1.235-3.221-.124-.303-.535-1.527.117-3.176 0 0 1.008-.322 3.3 1.23.957-.266 1.984-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.29-1.552 3.296-1.23 3.296-1.23.653 1.649.242 2.873.118 3.176.77.84 1.233 1.911 1.233 3.221 0 4.61-2.804 5.624-5.475 5.921.43.372.814 1.102.814 2.222v3.293c0 .32.192.694.8.576C20.565 21.796 24 17.297 24 12c0-6.63-5.37-12-12-12z"/>
    </svg>
</a>
{% endblock %}


{% block content %}
<div class="container mx-auto p-4">

    <!-- Text above search form -->
    <p class="text-sm text-gray-700 mb-2 mt-4">
        {% trans "Discover art through meaning-driven search!" %}
    </p>

     <!-- Search Form using HTMX -->
    <form
        id="search-form"
        hx-get="{% url 'get-artworks' %}"
        hx-target="#search-results"
        hx-swap="innerHTML"
        hx-include="#search-form"
        hx-on:submit="return validateSearchInput()"
        class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4 sm:mb-5">

        <!-- Search Input -->
        <input
            id="search-input"
            type="text"
            name="query"
            placeholder="{% trans "Search by theme, style, emotion, or more..." %}"
            value="{{ query|default:'' }}"
            class="w-full sm:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            required
        />

        <!-- Museum Dropdown -->
        <div
            id="museum-dropdown"
            class="w-full sm:w-auto"
            hx-get="{% url 'update-work-types' %}"
            hx-trigger="change delay:150ms"
            hx-include="#museum-dropdown, #work-type-container"
            hx-target="#work-type-container"
            hx-swap="innerHTML"
        >
            {% with filter_ctx=museum_filter_context %}
                {% include "partials/dropdown.html" %}
            {% endwith %}
        </div>

        <!-- Work Type Dropdown -->
        <div
            id="work-type-container"
            class="w-full sm:w-auto"
            hx-get="{% url 'update-museums' %}"
            hx-trigger="change delay:150ms"
            hx-include="#work-type-container, #museum-dropdown"
            hx-target="#museum-dropdown"
            hx-swap="innerHTML"
        >
            {% with filter_ctx=work_type_filter_context %}
                {% include "partials/dropdown.html" %}
            {% endwith %}
        </div>

        <!-- HTMX Submit Button -->
        <button
            type="submit"
            class="w-full sm:w-auto bg-blue-500 text-white px-8 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
            {% trans "Search" %}
        </button>

    </form>

    <!-- Example Queries Section -->
    <div class="mb-5">
        <p class="text-sm text-gray-600 mb-2">{% trans "Try these examples" %}</p>

        <!-- Desktop View: show all examples -->
        <div class="hidden sm:flex flex-wrap gap-2">
            {% for example in example_queries %}
            <button
                type="button"
                class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                onclick="insertQuery('{{ example }}')"
                hx-get="{% url 'get-artworks' %}"
                hx-target="#search-results"
                hx-swap="innerHTML"
                hx-include="#search-form"
            >
                {{ example }}
            </button>
            {% endfor %}
        </div>

        <!-- Mobile View: show a few examples and a "More"/"Less" toggle -->
        <div class="sm:hidden" x-data="{ showAll: false }"
             @htmx:after-swap.window="if ($event.detail.target.id === 'search-results') showAll = false">
            <!-- collapsed state -->
            <div class="flex flex-wrap gap-2" x-show="!showAll">
                {% for example in example_queries|slice:":5" %}
                <button
                    type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onclick="insertQuery('{{ example }}')"
                    hx-get="{% url 'get-artworks' %}"
                    hx-target="#search-results"
                    hx-swap="innerHTML"
                    hx-include="#search-form"
                >
                    {{ example }}
                </button>
                {% endfor %}
                <button
                    type="button"
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    x-on:click="showAll = true; setTimeout(() => $event.target.blur(), 100)"
                    x-on:touchend="setTimeout(() => $event.target.blur(), 100)"
                >
                    More
                </button>
            </div>

            <!-- expanded state -->
            <div class="flex flex-wrap gap-2" x-show="showAll">
                {% for example in example_queries %}
                <button
                    type="button"
                    class="bg-gray-200 text-gray-800 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onclick="insertQuery('{{ example }}')"
                    hx-get="{% url 'get-artworks' %}"
                    hx-target="#search-results"
                    hx-swap="innerHTML"
                    hx-include="#search-form"
                >
                    {{ example }}
                </button>
                {% endfor %}
                <button
                    type="button"
                    class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    x-on:click="showAll = false; setTimeout(() => $event.target.blur(), 100)"
                    x-on:touchend="setTimeout(() => $event.target.blur(), 100)"
                >
                    Less
                </button>
            </div>
        </div>
    </div>

    <!-- Error Message Placeholder -->
    <div id="error-message"></div>

    <!-- Get artworks -->
    <div id="search-results">
        <div
            hx-get="{% url 'get-artworks' %}"
            hx-trigger="revealed"
            hx-swap="outerHTML"
            class="py-4 text-center text-gray-500">
        </div>
    </div>
</div>

<!-- Full-screen Image Viewer -->
<div x-data="{
  open: false,
  url: '',
  showInfo: false,
  scrollY: 0,
  title: '',
  artist: '',
  productionDate: '',
  workTypes: [],
  museum: '',
  sourceUrl: '',
  apiUrl: '',
  findSimilarQuery: '',
  showFindSimilar: true,
  museumSlug: '',
  objectNumber: '',
  museumDbId: '',
  descriptionGenerated: false,
  descriptionLoaded: false,
  forceRegenerate: false,
  openWith(data) {
    this.url = data.url;
    this.title = data.title || '';
    this.artist = data.artist || '';
    this.productionDate = data.productionDate || '';
    this.workTypes = data.workTypes || [];
    this.museum = data.museum || '';
    this.sourceUrl = data.sourceUrl || '';
    this.apiUrl = data.apiUrl || '';
    this.findSimilarQuery = data.findSimilarQuery || '';
    this.showFindSimilar = data.showFindSimilar || false;
    this.museumSlug = data.museumSlug || '';
    this.objectNumber = data.objectNumber || '';
    this.museumDbId = data.museumDbId || '';
    this.open = true;
    this.showInfo = false;
    this.resetDescription();
    // iOS Safari scroll lock: position fixed approach
    this.scrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${this.scrollY}px`;
    document.body.style.width = '100%';
    document.body.style.overflowY = 'scroll';
  },
  close() {
    this.open = false;
    this.showInfo = false;
    this.resetDescription();
    // iOS Safari scroll lock: restore scroll position
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.style.overflowY = '';
    window.scrollTo(0, this.scrollY);
  },
  generateDescription(force = false) {
    this.descriptionGenerated = true;
    this.descriptionLoaded = false;
    this.forceRegenerate = force;
    this.$nextTick(() => {
      htmx.trigger('#artwork-description-container', 'loadDescription');
    });
  },
  resetDescription() {
    this.descriptionGenerated = false;
    this.descriptionLoaded = false;
    this.forceRegenerate = false;
    const container = document.getElementById('artwork-description-container');
    if (container) {
      container.innerHTML = '';
    }
  }
}"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 bg-black/95 h-screen supports-[height:100svh]:h-svh w-screen"
     style="touch-action: none;"
     @keydown.escape.window="if (open) close()"
     @keydown.space.window="if (open) { $event.prevent
          +Default(); showInfo = !showInfo; }"
     @open-viewer.window="openWith($event.detail)"
     @click="close()">

  <!-- Top bar -->
  <div class="absolute top-0 left-0 right-0 p-3 text-white z-10"
       @click.stop>
    <!-- Close button - absolute left -->
    <button class="absolute left-3 top-3 px-3 py-1 rounded bg-white/10 hover:bg-white/20 transition"
            @click="close()">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
  </div>

  <!-- Image: uses whole viewport, never inside a scrollable parent -->
  <div class="w-screen h-screen flex items-center justify-center">
    <img :src="url"
         alt="Artwork"
         class="block max-w-[100vw] max-h-[100vh] select-none cursor-pointer"
         @click.stop="showInfo = !showInfo"
         draggable="false">
  </div>

  <!-- Info drawer -->
  <div x-show="showInfo"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0 translate-y-4 lg:translate-y-0 lg:translate-x-4"
       x-transition:enter-end="opacity-100 translate-y-0 lg:translate-x-0"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100 translate-y-0 lg:translate-x-0"
       x-transition:leave-end="opacity-0 translate-y-4 lg:translate-x-4"
       class="absolute bottom-0 left-0 right-0 lg:left-auto lg:top-0 lg:bottom-0 lg:w-96 bg-white text-gray-900 border-t lg:border-t-0 lg:border-l border-gray-200 max-h-[45vh] lg:max-h-none overflow-y-auto p-6 pb-[calc(1.5rem+env(safe-area-inset-bottom))]"
       @click.stop>

    <!-- Metadata block -->
    <div class="space-y-1">
      <!-- Title -->
      <h3 class="text font-semibold text-gray-800 leading-snug" x-text="title"></h3>

      <!-- Artist -->
      <p class="text-base text-gray-500" x-text="artist"></p>

      <!-- Production date and Work Types -->
      <div class="flex flex-wrap gap-2 mt-1">
        <span x-show="productionDate"
              x-text="productionDate"
              class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-md font-medium">
        </span>
        <template x-for="workType in workTypes" :key="workType">
          <span x-text="workType"
                class="text-sm bg-gray-200 text-gray-700 px-2 py-0.5 rounded-md font-medium">
          </span>
        </template>
      </div>
    </div>

    <!-- Museum link and Find similar button -->
    <div class="flex flex-wrap gap-3 mt-4">
      <!-- Museum link -->
      <p x-show="museum && sourceUrl">
        <a :href="sourceUrl"
           target="_blank"
           rel="noopener noreferrer"
           class="text-sm text-gray-600 inline-flex items-center gap-1 underline hover:text-blue-500"
           :title="'View this artwork on the ' + museum + ' website'">
          <span x-text="museum"></span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6m5-5h5m0 0v5m0-5L10 14" />
          </svg>
        </a>
      </p>

      <!-- Find similar button -->
      <div x-show="showFindSimilar">
        <button
          type="button"
          class="text-sm text-gray-600 hover:text-blue-500 underline"
          @click="insertQuery(findSimilarQuery); close()"
          hx-get="{% url 'get-artworks' %}"
          hx-target="#search-results"
          hx-swap="innerHTML"
          hx-include="#search-form">
          Find similar
        </button>
      </div>
    </div>

    <!-- Description section -->
    <div class="mt-3 sm:mt-6">
      <!-- State 1: Initial - Generate button -->
      <div x-show="!descriptionGenerated" class="text-center py-4">
        <button
          @click="generateDescription()"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd" />
          </svg>
          <span>Tell me about this artwork</span>
        </button>
      </div>

      <!-- State 2: Loading - Inline spinner -->
      <div x-show="descriptionGenerated && !descriptionLoaded" class="flex items-center justify-center py-8">
        <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="ml-3 text-sm text-gray-600 font-medium">Generating description...</p>
      </div>

      <!-- State 3: Loaded - Description content with regenerate option -->
      <div x-show="descriptionLoaded">
        <!-- Heading and regenerate button -->
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-700">About this artwork</h3>
          <button
            @click="generateDescription(true)"
            class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white text-gray-700 font-medium text-xs rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            <span>Regenerate</span>
          </button>
        </div>

        <!-- Description container (HTMX target) -->
        <div
          id="artwork-description-container"
          class="break-words"
          hx-get="{% url 'get-artwork-description' %}"
          hx-trigger="loadDescription"
          x-bind:hx-vals="JSON.stringify(forceRegenerate ? {museum: museumSlug, object_number: objectNumber, museum_db_id: museumDbId, force: 'true'} : {museum: museumSlug, object_number: objectNumber, museum_db_id: museumDbId})"
          hx-swap="innerHTML"
          @htmx:after-swap="descriptionLoaded = true; forceRegenerate = false">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript Functions -->
<script>
    function validateSearchInput() {
        const input = document.getElementById("search-input");
        if (!input.value.trim()) {
            input.focus();
            input.reportValidity();  // shows browser's native "Please fill out this field" popup
            return false;
        }
        return true;
    }

    function insertQuery(query) {
        document.getElementById('search-input').value = query;
    }

    function dropdownComponent({ selected, all, labelAll, labelSingular, labelPlural }) {
        return {
            open: false,
            selectedItems: [...selected],
            allItems: [...all],

            toggleSelectAll() {
                if (this.selectedItems.length === this.allItems.length) {
                    this.selectedItems = [];
                } else {
                    this.selectedItems = [...this.allItems];
                }
            },

            get buttonLabel() {
                if (this.selectedItems.length === 0 || this.selectedItems.length === this.allItems.length) {
                    return labelAll;
                } else if (this.selectedItems.length === 1) {
                    return `1 ${labelSingular}`;
                } else {
                    return `${this.selectedItems.length} ${labelPlural}`;
                }
            }
        };
    }

  function openModal(imageUrl, museumSlug, objectNumber, museumDbId, title, artist, productionDate, sourceUrl, apiUrl, museum, workTypes = []) {
    window.dispatchEvent(new CustomEvent('open-viewer', {
      detail: {
        url: imageUrl,
        title,
        artist,
        productionDate,
        workTypes,
        museum,
        sourceUrl,
        apiUrl,
        findSimilarQuery: `${museumSlug}:${objectNumber}`,
        showFindSimilar: true,
        museumSlug,
        objectNumber,
        museumDbId
      }
    }));
  }
</script>

<script>
    document.body.addEventListener('htmx:afterSwap', (evt) => {
      if (evt.detail.target.id === 'search-results') {
        window.scrollTo({ top: 0, behavior: 'auto' });
      }
    });
</script>
{% endblock content %}
